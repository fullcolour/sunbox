<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Weather · 7 Day Forecast</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont;
  background:#0b1220;
  color:#fff;
}
.container{
  max-width:520px;
  margin:20px auto;
  padding:16px;
}
.card{
  background:rgba(255,255,255,0.06);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}
input,button{
  padding:10px;
  border-radius:10px;
  border:none;
}
input{
  width:70%;
}
button{
  background:#4f8cff;
  color:#fff;
  margin-left:6px;
}
.day{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
.small{opacity:.7;font-size:13px}
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <input id="cityInput" placeholder="输入城市，如 Tokyo">
    <button id="searchBtn">搜寻</button>
    <div id="status" class="small"></div>
  </div>

  <div id="current" class="card"></div>
  <div id="forecast" class="card"></div>

</div>

<script>
const PROXY = "/proxy";

async function proxyFetch(url){
  const res = await fetch(PROXY + "?url=" + encodeURIComponent(url));
  if(!res.ok) throw new Error("Proxy failed");
  return res.json();
}

async function geocode(city){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`;
  return proxyFetch(url);
}

async function weather(lat,lon){
  const url =
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${lat}&longitude=${lon}` +
    `&current_weather=true` +
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max` +
    `&forecast_days=7&timezone=auto`;
  return proxyFetch(url);
}

function render(data, city){
  const cw = data.current_weather;
  const d = data.daily;

  document.getElementById("current").innerHTML = `
    <h3>${city}</h3>
    <div>当前温度：${cw.temperature}°C</div>
    <div class="small">风速 ${cw.windspeed} m/s</div>
  `;

  let html = "<h3>未来 7 天</h3>";
  for(let i=0;i<d.time.length;i++){
    html += `
      <div class="day">
        <div>${d.time[i]}</div>
        <div>${d.temperature_2m_min[i]}° / ${d.temperature_2m_max[i]}°</div>
      </div>`;
  }
  document.getElementById("forecast").innerHTML = html;
}

document.getElementById("searchBtn").onclick = async ()=>{
  const city = cityInput.value.trim();
  if(!city) return;

  status.textContent = "查询中…";

  try{
    const geo = await geocode(city);
    if(!geo.length) throw new Error("城市不存在");

    const w = await weather(geo[0].lat, geo[0].lon);
    render(w, geo[0].display_name);
    status.textContent = "";
  }catch(e){
    status.textContent = "查询失败";
  }
};
</script>
</body>
</html>
