<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>天气查询 · 实时 + 7 天预报</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* —— 样式保持不变，略（你原样保留即可） —— */
</style>
</head>

<body>
<div class="container">
  <!-- UI 部分保持不变 -->
</div>

<script>
/* ========================
   基础工具
======================== */
const PROXY_BASE = '/proxy';
const el = id => document.getElementById(id);

function log(msg){
  const area = el('logArea');
  const d = document.createElement('div');
  d.style.padding='6px 0';
  d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  area.prepend(d);
}

/* ========================
   Proxy Fetch
======================== */
async function fetchProxy(apiUrl) {
  const res = await fetch(`${PROXY_BASE}?url=${encodeURIComponent(apiUrl)}`);
  if (!res.ok) throw new Error('Proxy error');
  return res;
}

/* ========================
   API
======================== */
async function geocode(q) {
  const api = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`;
  const res = await fetchProxy(api);
  return res.json();
}

async function fetchWeather(lat, lon, units) {
  const tempUnit = units === 'imperial' ? 'fahrenheit' : 'celsius';
  const windUnit = units === 'imperial' ? 'mph' : 'ms';

  const api =
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${lat}&longitude=${lon}` +
    `&current_weather=true` +
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max` +
    `&forecast_days=7` +
    `&temperature_unit=${tempUnit}` +
    `&windspeed_unit=${windUnit}` +
    `&timezone=auto`;

  const res = await fetchProxy(api);
  return res.json();
}

/* ========================
   渲染
======================== */
function renderWeather(data,label){
  const cw = data.current_weather;
  const daily = data.daily;
  const unitTemp = el('units').value === 'imperial' ? '°F' : '°C';
  const windUnit = el('units').value === 'imperial' ? 'mph' : 'm/s';

  let html = `<div class="meta">当前天气 · ${label}</div>`;
  html += `<div class="kv"><div>温度</div><div>${cw.temperature}${unitTemp}</div></div>`;
  html += `<div class="kv"><div>风速</div><div>${cw.windspeed} ${windUnit}</div></div>`;

  html += `<div class="meta" style="margin-top:8px">未来 7 天</div><div class="forecast-row">`;
  for (let i = 0; i < daily.time.length; i++) {
    html += `
      <div class="forecast-card">
        <div>${daily.time[i]}</div>
        <div>高 ${daily.temperature_2m_max[i]}${unitTemp}</div>
        <div>低 ${daily.temperature_2m_min[i]}${unitTemp}</div>
      </div>`;
  }
  html += `</div>`;

  el('weatherResult').innerHTML = html;
}

/* ========================
   交互
======================== */
async function searchPlace(){
  const q = el('placeInput').value.trim();
  if(!q) return;

  el('weatherResult').innerText = '搜索中…';
  const list = await geocode(q);

  el('weatherResult').innerHTML = list.map(p =>
    `<div class="card place" data-lat="${p.lat}" data-lon="${p.lon}">${p.display_name}</div>`
  ).join('');

  document.querySelectorAll('.place').forEach(n=>{
    n.onclick = () => loadWeather(n.dataset.lat, n.dataset.lon, n.textContent);
  });
}

async function loadWeather(lat,lon,label){
  const data = await fetchWeather(lat,lon,el('units').value);
  renderWeather(data,label);
}

el('searchPlaceBtn').onclick = searchPlace;
el('locateBtn').onclick = () => {
  navigator.geolocation.getCurrentPosition(pos=>{
    loadWeather(pos.coords.latitude, pos.coords.longitude, '当前位置');
  });
};
</script>
</body>
</html>
